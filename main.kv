#:import NoTransition kivy.uix.screenmanager.NoTransition
#:import ButtonBehavior kivy.uix.behaviors.button.ButtonBehavior
#:import PINK_BG ui.colors.PINK_BG
#:import PURPLE_BG ui.colors.PURPLE_BG
#:import TempoVisualizer ui.tempo_visualizer.TempoVisualizer
RootUI:
    WelcomeScreen:
        name: "welcome"
    HomeScreen:
        name: "home"
    PresetsScreen:
        name: "presets"
    PresetDetailScreen:
        name: "preset_detail"
    ExerciseLibraryScreen:
        name: "exercise_library"
    ProgressScreen:
        name: "progress"
    WorkoutHistoryScreen:
        name: "workout_history"
    ViewPreviousWorkoutScreen:
        name: "view_previous_workout"
    SettingsScreen:
        name: "settings"
    RestScreen:
        name: "rest"
    WorkoutActiveScreen:
        name: "workout_active"
    MetricInputScreen:
        name: "metric_input"
    WorkoutEditScreen:
        name: "workout_edit"
    WorkoutSummaryScreen:
        name: "workout_summary"
    EditExerciseScreen:
        name: "edit_exercise"
    EditPresetScreen:
        name: "edit_preset"
    PresetOverviewScreen:
        name: "preset_overview"
    PreviousWorkoutsScreen:
        name: "previous_workouts"

<HomeScreen>:
    md_bg_color: PINK_BG
    ScrollView:
        do_scroll_x: False
        MDBoxLayout:
            orientation: "vertical"
            size_hint_y: None
            height: self.minimum_height
            spacing: "10dp"
            padding: "20dp"
            MDLabel:
                text: "Home"
                halign: "center"
                theme_text_color: "Custom"
                text_color: 0.2, 0.6, 0.86, 1
            MDRaisedButton:
                text: "Presets"
                on_release: app.root.current = "presets"
            MDRaisedButton:
                text: "Library"
                on_release: app.root.current = "exercise_library"
            MDRaisedButton:
                text: "Progress"
                on_release: app.root.current = "progress"
            MDRaisedButton:
                text: "Settings"
                on_release: app.open_settings('home')
            MDRaisedButton:
                text: "History"
                on_release: app.root.current = "workout_history"

<PresetsScreen>:
    preset_list: preset_list
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        ScrollView:
            MDList:
                id: preset_list
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: "48dp"
            spacing: "10dp"
            MDIconButton:
                icon: "arrow-left"
                on_release: app.root.current = "home"
            MDIconButton:
                icon: "pencil"
                disabled: not root.selected_preset
                on_release: app.root.current = "edit_preset"
            MDIconButton:
                icon: "plus"
                on_release: app.start_new_preset(); app.root.current = "edit_preset"

<PresetDetailScreen>:
    summary_list: summary_list
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            text: root.preset_name if root.preset_name else "Preset Detail - view exercises in this preset"
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.86, 1
        ScrollView:
            MDList:
                id: summary_list
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: "48dp"
            spacing: "10dp"
            MDIconButton:
                icon: "arrow-left"
                on_release: app.root.current = "presets"
            MDIconButton:
                icon: "pencil"
                on_release: app.root.current = "edit_preset"
            MDIconButton:
                icon: "arrow-right"
                on_release: app.root.current = "preset_overview"

<ExerciseRow@MDBoxLayout>:
    name: ""
    text: ""
    is_user_created: False
    edit_callback: None
    delete_callback: None
    orientation: "horizontal"
    size_hint_y: None
    height: "56dp"
    padding: "8dp"
    MDLabel:
        id: name_label
        text: root.text
        size_hint_x: 1
        theme_text_color: "Custom"
        text_color: (0.6, 0.2, 0.8, 1) if root.is_user_created else (0, 0, 0, 1)
        halign: "left"
        valign: "center"
    MDBoxLayout:
        size_hint_x: None
        width: "36dp"
        orientation: "horizontal"
        spacing: "5dp"
        valign: "center"
        MDIcon:
            icon: "pencil"
            font_size: "20sp"
            pos_hint: {"center_y": 0.5}
            on_touch_down: if self.collide_point(*args[1].pos) and root.edit_callback: root.edit_callback(root.name, root.is_user_created)
        MDIcon:
            icon: "delete"
            font_size: "20sp"
            theme_text_color: "Custom"
            text_color: 1, 0, 0, 1
            pos_hint: {"center_y": 0.5}
            opacity: 1 if root.is_user_created else 0
            disabled: not root.is_user_created
            on_touch_down: if self.collide_point(*args[1].pos) and root.delete_callback: root.delete_callback(root.name)

<MetricRow@MDBoxLayout>:
    name: ""
    text: ""
    is_user_created: False
    edit_callback: None
    delete_callback: None
    locked: False
    orientation: "horizontal"
    size_hint_y: None
    height: "56dp"
    padding: "8dp"
    MDLabel:
        text: root.text
        size_hint_x: 1
        theme_text_color: "Custom"
        text_color: (0.6, 0.2, 0.8, 1) if root.is_user_created else (0, 0, 0, 1)
        halign: "left"
        valign: "center"
    MDBoxLayout:
        size_hint_x: None
        width: "36dp" if not root.locked else 0
        orientation: "horizontal"
        spacing: "5dp"
        valign: "center"
        MDIcon:
            icon: "pencil"
            font_size: "20sp"
            pos_hint: {"center_y": 0.5}
            opacity: 1 if not root.locked else 0
            disabled: root.locked
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos) and root.edit_callback: root.edit_callback(root.name, root.is_user_created)
        MDIcon:
            icon: "delete"
            font_size: "20sp"
            theme_text_color: "Custom"
            text_color: 1, 0, 0, 1
            pos_hint: {"center_y": 0.5}
            opacity: 1 if root.is_user_created and not root.locked else 0
            disabled: not root.is_user_created or root.locked
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos) and root.delete_callback: root.delete_callback(root.name)

<ExerciseLibraryScreen>:
    exercise_list: exercise_list
    metric_list: metric_list
    current_tab: "exercises"
    md_bg_color: PINK_BG
    FloatLayout:
        MDBoxLayout:
            orientation: "vertical"
            spacing: "5dp"
            padding: "20dp"
            MDBoxLayout:
                size_hint_y: None
                height: "40dp"
                spacing: "10dp"
                MDRaisedButton:
                    text: "Exercises"
                    md_bg_color: app.theme_cls.primary_color if root.current_tab == "exercises" else (.5, .5, .5, 1)
                    on_release: root.switch_tab("exercises")
                MDRaisedButton:
                    text: "Metrics"
                    md_bg_color: app.theme_cls.primary_color if root.current_tab == "metrics" else (.5, .5, .5, 1)
                    on_release: root.switch_tab("metrics")
            ScreenManager:
                id: library_tabs
                size_hint_y: 1
                transition: NoTransition()
                on_kv_post: self.current = root.current_tab
                Screen:
                    name: "exercises"
                    BoxLayout:
                        orientation: "vertical"
                        MDBoxLayout:
                            orientation: "horizontal"
                            size_hint_y: None
                            height: "40dp"
                            spacing: "5dp"
                            MDTextField:
                                id: search_field
                                hint_text: "Search exercises"
                                text: root.search_text
                                on_text: root.update_search(self.text)
                                size_hint_y: None
                                height: "40dp"
                                size_hint_x: 1
                            MDIconButton:
                                icon: "filter-variant"
                                on_release: root.open_filter_popup()
                                size_hint: None, None
                                size: "40dp", "40dp"
                        MDRecycleView:
                            id: exercise_list
                            viewclass: "ExerciseRow"
                            RecycleBoxLayout:
                                default_size: None, dp(56)
                                default_size_hint: 1, None
                                size_hint_y: None
                                height: self.minimum_height
                                orientation: "vertical"
                        MDBoxLayout:
                            orientation: "horizontal"
                            size_hint_y: None
                            height: "48dp"
                            spacing: "10dp"
                            MDIconButton:
                                icon: "arrow-left"
                                on_release: root.go_back()
                            Widget:
                            MDIconButton:
                                icon: "plus"
                                on_release: root.new_exercise()
                Screen:
                    name: "metrics"
                    BoxLayout:
                        orientation: "vertical"
                        MDBoxLayout:
                            orientation: "horizontal"
                            size_hint_y: None
                            height: "40dp"
                            spacing: "5dp"
                            MDTextField:
                                id: metric_search_field
                                hint_text: "Search metrics"
                                text: root.metric_search_text
                                on_text: root.update_search(self.text)
                                size_hint_y: None
                                height: "40dp"
                                size_hint_x: 1
                            MDIconButton:
                                icon: "filter-variant"
                                on_release: root.open_filter_popup()
                                size_hint: None, None
                                size: "40dp", "40dp"
                        MDRecycleView:
                            id: metric_list
                            viewclass: "MetricRow"
                            RecycleBoxLayout:
                                default_size: None, dp(56)
                                default_size_hint: 1, None
                                size_hint_y: None
                                height: self.minimum_height
                                orientation: "vertical"
                        MDBoxLayout:
                            orientation: "horizontal"
                            size_hint_y: None
                            height: "48dp"
                            spacing: "10dp"
                            MDIconButton:
                                icon: "arrow-left"
                                on_release: root.go_back()
                            Widget:
                            MDIconButton:
                                icon: "plus"
                                on_release: root.new_metric()

<ProgressScreen@MDScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            text: "Progress - track your performance"
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.86, 1
        MDRaisedButton:
            text: "Back"
            on_release: app.root.current = root.return_to

<WorkoutHistoryScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        ScrollView:
            do_scroll_x: False
            MDList:
                id: history_list
        MDRaisedButton:
            text: "Back"
            on_release: app.root.current = root.return_to

<ViewPreviousWorkoutScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        ScrollView:
            do_scroll_x: False
            MDList:
                id: details_list
        MDRaisedButton:
            text: "Back"
            on_release: app.root.current = "workout_history"

<SettingsScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        # ScrollView ensures remaining settings are accessible on small screens
        ScrollView:
            do_scroll_x: False
            MDBoxLayout:
                orientation: "vertical"
                spacing: "10dp"
                size_hint_y: None
                height: self.minimum_height
                MDBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: "40dp"
                    MDLabel:
                        text: "Sound"
                        valign: "center"
                    MDSwitch:
                        id: sound_toggle
                        pos_hint: {"center_y": 0.5}
                        on_active: root.on_sound_toggle(self, self.active)
                MDBoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: "40dp"
                    MDLabel:
                        text: "Sound Level"
                        valign: "center"
                    MDSlider:
                        id: sound_level_slider
                        min: 0
                        max: 1
                        value: 1
                        on_value: root.on_sound_level(self, self.value)
                MDBoxLayout:
                    orientation: "vertical"
                    spacing: "10dp"
                    size_hint_y: None
                    height: self.minimum_height
                    MDRaisedButton:
                        text: "Export DB"
                        size_hint_y: None
                        height: "40dp"
                        on_release: root.export_db()
                    MDRaisedButton:
                        text: "Export JSON"
                        size_hint_y: None
                        height: "40dp"
                        on_release: root.export_json()
                    MDRaisedButton:
                        text: "Import DB"
                        size_hint_y: None
                        height: "40dp"
                        on_release: root.open_import_db()
        MDRaisedButton:
            text: "Back"
            on_release: app.root.current = root.return_to

<IconTextButton@MDCard>:
    on_press: print("IconTextButton pressed:", root.icon)
    icon: ""
    text: ""
    text_color: 0, 0, 0, 1
    md_bg_color: 0, 0, 0, 0
    padding: "8dp"
    size_hint_x: None
    width: "90dp"
    size_hint_y: None
    height: "90dp"

    MDBoxLayout:
        orientation: "vertical"
        spacing: "4dp" if root.text else 0
        size_hint: 1, None
        height: self.minimum_height
        pos_hint: {"center_y": 0.5}

        MDIcon:
            icon: root.icon
            font_size: "32sp"
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5}
            theme_text_color: "Custom"
            text_color: root.text_color

        MDLabel:
            text: root.text
            font_size: "10sp"
            halign: "center"
            text_size: None, None
            size_hint_y: None
            height: self.texture_size[1] if root.text else 0
            opacity: 1 if root.text else 0
            theme_text_color: "Custom"
            text_color: root.text_color

<RestScreen>:
    md_bg_color: PURPLE_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        BoxLayout:
            size_hint_y: None
            height: self.minimum_height
            MDLabel:
                text: root.session_time_label
                size_hint_y: None
                height: self.texture_size[1]
                halign: "left"
                multiline: False
                theme_text_color: "Custom"
                text_color: 0.2, 0.6, 0.86, 1
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: self.minimum_height
            MDIconButton:
                icon: "minus"
                on_release: root.adjust_timer_by_direction(-1)
            MDLabel:
                id: timer_label
                text: root.timer_label
                halign: "center"
                font_style: "H4"
                theme_text_color: "Custom"
                text_color: root.timer_color
            MDIconButton:
                icon: "plus"
                on_release: root.adjust_timer_by_direction(1)
        MDLabel:
            text: "Next: " + root.next_exercise_name if root.next_exercise_name else ""
            halign: "center"
        MDLabel:
            text: root.next_exercise_desc if root.next_exercise_desc else ""
            halign: "center"
        MDLabel:
            text: root.next_set_info if root.next_set_info else ""
            halign: "center"
        MDLabel:
            text: root.rest_time_info if root.rest_time_info else ""
            halign: "center"
        Widget:
            size_hint_y: None
            height: "20dp"
        ScrollView:
            size_hint_y: None
            height: "100dp"
            bar_width: 0
            do_scroll_y: False
            do_scroll_x: True
            MDBoxLayout:
                orientation: "horizontal"
                spacing: "10dp"
                size_hint_y: None
                height: self.minimum_height
                size_hint_x: None
                width: self.minimum_width
                IconTextButton:
                    icon: "undo"
                    disabled: root.undo_disabled
                    on_release: root.show_undo_confirmation()
                IconTextButton:
                    icon: "skip-next"
                    on_release: root.show_skip_confirmation()
                IconTextButton:
                    id: record_btn
                    icon: "clipboard"
                    on_release: root.open_metric_input()
                IconTextButton:
                    icon: "pencil"
                    on_release: app.edit_active_preset()
                IconTextButton:
                    icon: "cog"
                    on_release: app.open_settings('rest')
                IconTextButton:
                    icon: "book"
                    on_release: app.root.current = "previous_workouts"
                IconTextButton:
                    icon: "flag-checkered"
                    on_release: root.confirm_finish()

<WorkoutActiveScreen>:
    tempo_bar: tempo_bar
    on_leave: root.stop_timer()
    md_bg_color: PURPLE_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            id: stopwatch
            text: root.formatted_time
            halign: "center"
            font_name: root.digital_font
            font_style: "H2"
            multiline: False
        MDLabel:
            text: root.exercise_name
            halign: "center"
        TempoVisualizer:
            id: tempo_bar
            size_hint_y: None
            height: dp(8)
            opacity: 0
        MDBoxLayout:
            orientation: "horizontal"
            spacing: "10dp"
            MDRaisedButton:
                text: "Undo"
                on_release: root.show_undo_confirmation()
            MDRaisedButton:
                text: "Finish"
                on_release:
                    app.record_new_set = True
                    app.mark_set_complete()
                    app.root.current = "metric_input"
            MDRaisedButton:
                text: "-5"
                on_release:
                    app.record_new_set = True
                    app.mark_set_complete(-5)
                    app.root.current = "metric_input"
            MDRaisedButton:
                text: "-10"
                on_release:
                    app.record_new_set = True
                    app.mark_set_complete(-10)
                    app.root.current = "metric_input"

<MetricInputScreen>:
    on_pre_enter: root.on_pre_enter()
    exercise_bar: exercise_bar
    metric_names: metric_names
    metric_values: metric_values
    metric_names_scroll: metric_names_scroll
    metric_values_scroll: metric_values_scroll
    set_headers: set_headers
    md_bg_color: PURPLE_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        ScrollView:
            id: exercise_scroll
            size_hint_y: None
            height: dp(40)
            do_scroll_x: True
            do_scroll_y: False
            bar_width: 0
            BoxLayout:
                id: exercise_bar
                orientation: "horizontal"
                size_hint_x: None
                width: self.minimum_width
                height: dp(40)
                spacing: dp(10)
                padding: "0dp", "0dp"
        ScrollView:
            size_hint_y: None
            height: "40dp"
            do_scroll_x: True
            do_scroll_y: False
            bar_width: 0
            BoxLayout:
                orientation: "horizontal"
                size_hint_x: None
                width: self.minimum_width
                size_hint_y: None
                height: "40dp"
                spacing: "5dp"
                padding: "0dp", "10dp"
                MDFlatButton:
                    id: required_btn
                    text: "Required"
                    size_hint: None, None
                    width: dp(110)
                    height: "40dp"
                    font_size: "14sp"
                    md_bg_color: root.required_color
                    text_color: 1, 1, 1, 1
                    on_release: root.toggle_filter('required')
                MDFlatButton:
                    id: additional_btn
                    text: "Additional"
                    size_hint: None, None
                    width: dp(110)
                    height: "40dp"
                    font_size: "14sp"
                    md_bg_color: root.additional_color
                    text_color: 1, 1, 1, 1
                    on_release: root.toggle_filter('additional')
                MDFlatButton:
                    id: pre_btn
                    text: "Pre Set"
                    size_hint: None, None
                    width: dp(110)
                    height: "40dp"
                    font_size: "14sp"
                    md_bg_color: root.pre_color
                    text_color: 1, 1, 1, 1
                    on_release: root.toggle_filter('pre')
                MDFlatButton:
                    id: post_btn
                    text: "Post Set"
                    size_hint: None, None
                    width: dp(110)
                    height: "40dp"
                    font_size: "14sp"
                    md_bg_color: root.post_color
                    text_color: 1, 1, 1, 1
                    on_release: root.toggle_filter('post')
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: 1
            BoxLayout:
                orientation: "vertical"
                size_hint_x: None
                width: dp(100)
                Widget:
                    size_hint_y: None
                    height: dp(30)
                ScrollView:
                    id: metric_names_scroll
                    do_scroll_x: False
                    do_scroll_y: True
                    bar_width: 0
                    BoxLayout:
                        id: metric_names
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(5)
            BoxLayout:
                orientation: "vertical"
                ScrollView:
                    id: set_header_scroll
                    size_hint_y: None
                    height: dp(30)
                    do_scroll_x: True
                    do_scroll_y: False
                    bar_width: 0
                    BoxLayout:
                        id: set_headers
                        orientation: "horizontal"
                        size_hint_x: None
                        width: self.minimum_width
                        height: dp(30)
                        spacing: dp(5)
                ScrollView:
                    id: metric_values_scroll
                    do_scroll_x: True
                    do_scroll_y: True
                    bar_width: 0
                    GridLayout:
                        id: metric_values
                        size_hint: None, None
                        cols: 1
                        row_default_height: dp(40)
                        height: self.minimum_height
                        width: self.minimum_width
                        spacing: dp(5)
        MDRaisedButton:
            size_hint_y: 0.1
            text: "Back"
            on_release: root.save_metrics()

<WorkoutEditScreen@MDScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            text: "Workout Edit - tweak exercises in this session"
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.86, 1
        MDRaisedButton:
            text: "Back to Rest"
            on_release: app.root.current = "rest"

<WorkoutSummaryScreen>:
    summary_list: summary_list
    md_bg_color: PURPLE_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            text: "Workout Summary - results from this session"
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.86, 1
        ScrollView:
            MDList:
                id: summary_list
        MDRaisedButton:
            text: "Back to Home"
            on_release: app.root.current = "home"

<WelcomeScreen>:
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDLabel:
            text: app.app_version
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.5, 0.5, 0.5, 1
            font_style: "Caption"
            adaptive_height: True
        MDLabel:
            text: "Welcome - start your fitness journey"
            halign: "center"
            theme_text_color: "Custom"
            text_color: 0.2, 0.6, 0.86, 1
        MDRaisedButton:
            text: "Enter"
            on_release: app.root.current = "home"

<SectionWidget>:
    orientation: "vertical"
    size_hint_y: None
    height: self.minimum_height if root.visible else 0
    opacity: 1 if root.visible else 0
    md_bg_color: root.color
    padding: "10dp"
    MDBoxLayout:
        size_hint_y: None
        height: "40dp"
        MDTextField:
            text: root.section_name
            multiline: False
            hint_text: "Section Name"
            on_text: root.section_name = self.text
            disabled: root.locked
        MDIconButton:
            icon: "chevron-down" if root.expanded else "chevron-right"
            on_release: root.toggle()
    BoxLayout:
        id: exercises_box
        orientation: "vertical"
        size_hint_y: None
        height: self.minimum_height if root.expanded else 0
        opacity: 1 if root.expanded else 0
        MDList:
            id: exercise_list
            size_hint_y: None
            height: self.minimum_height
        MDBoxLayout:
            size_hint_y: None
            height: "40dp"
            spacing: "10dp"
            MDRaisedButton:
                text: "Add Exercise"
                on_release: root.open_exercise_selection()
                disabled: root.locked
                opacity: 1 if not root.locked else 0
            MDRaisedButton:
                text: "Delete"
                md_bg_color: 1, 0, 0, 1
                on_release: root.confirm_delete()
                disabled: root.locked
                opacity: 1 if not root.locked else 0

<EditPresetScreen>:
    sections_box: sections_box
    exercise_panel: exercise_panel
    details_box: details_box
    metrics_box: metrics_box
    panel_visible: False
    on_current_tab: edit_tabs.current = self.current_tab
    md_bg_color: PINK_BG
    FloatLayout:
        MDBoxLayout:
            id: main_content
            orientation: "vertical"
            spacing: "10dp"
            padding: "5dp"
            size_hint: 1, 1

            # Wrap navigation buttons in a horizontal ScrollView so they remain
            # accessible on small screens without altering existing logic.
            ScrollView:
                size_hint_y: None
                height: "40dp"
                do_scroll_y: False  # only horizontal scrolling is allowed
                bar_width: 0  # hide scrollbar for cleaner UI
                MDBoxLayout:
                    orientation: "horizontal"
                    size_hint_x: None
                    height: "40dp"
                    width: self.minimum_width
                    spacing: "10dp"
                    MDRaisedButton:
                        text: "Sections"
                        md_bg_color: app.theme_cls.primary_color if root.current_tab == "sections" else (.5, .5, .5, 1)
                        on_release: root.switch_tab("sections")
                    MDRaisedButton:
                        text: "Details"
                        md_bg_color: app.theme_cls.primary_color if root.current_tab == "details" else (.5, .5, .5, 1)
                        on_release: root.switch_tab("details")
                    MDRaisedButton:
                        text: "Metrics"
                        md_bg_color: app.theme_cls.primary_color if root.current_tab == "metrics" else (.5, .5, .5, 1)
                        on_release: root.switch_tab("metrics")

            ScreenManager:
                id: edit_tabs
                size_hint_y: 1
                transition: NoTransition()
                on_kv_post: self.current = root.current_tab

                Screen:
                    name: "sections"
                    BoxLayout:
                        orientation: "vertical"
                        ScrollView:
                            size_hint: 1, 1
                            MDBoxLayout:
                                orientation: "vertical"
                                size_hint_y: None
                                height: self.minimum_height
                                padding: 0, 0, 0, root.exercise_panel.height if root.panel_visible else 0
                                MDBoxLayout:
                                    id: sections_box
                                    orientation: "vertical"
                                    padding: "10dp"
                                    spacing: "10dp"
                                    size_hint_y: None
                                    height: self.minimum_height
                        # Removed floating action button to place all actions
                        # in a single bottom bar for better use of space on
                        # small screens. Section adding is now handled by the
                        # plus icon in the bottom bar.


                Screen:
                    name: "details"
                    on_enter: root.populate_details()
                    FloatLayout:
                        ScrollView:
                            id: details_scroll
                            do_scroll_x: False
                            MDBoxLayout:
                                id: details_box
                                orientation: "vertical"
                                size_hint_y: None
                                height: self.minimum_height
                                spacing: dp(10)
                                MDBoxLayout:
                                    id: preset_name_row
                                    orientation: "horizontal"
                                    size_hint_y: None
                                    height: "40dp"
                                    MDLabel:
                                        text: "Preset Name"
                                        size_hint_x: 0.4
                                    MDTextField:
                                        id: preset_name
                                        hint_text: "Preset Name"
                                        multiline: False
                                        on_text: root.update_preset_name(self.text)
                                        size_hint_x: 1
                                        readonly: root.mode == "session"
                                MDBoxLayout:
                                    id: metrics_box
                                    orientation: "vertical"
                                    size_hint_y: None
                                    height: self.minimum_height
                                    spacing: dp(10)
                        MDFloatingActionButton:
                            id: add_metric_btn
                            icon: "plus"
                            md_bg_color: app.theme_cls.primary_color
                            pos_hint: {"center_x": 0.5, "y": 0.02}
                            tooltip_text: "Add Metric"
                            opacity: 1 if root.mode != "session" else 0
                            disabled: root.mode == "session"
                            on_release: root.open_add_preset_metric_popup()

                Screen:
                    name: "metrics"
                    FloatLayout:
                        BoxLayout:
                            orientation: "vertical"
                            MDLabel:
                                text: "Required Session Metrics"
                                halign: "center"
                                theme_text_color: "Custom"
                                text_color: 0.2, 0.6, 0.86, 1
                                size_hint_y: None
                                height: "40dp"
                            MDRecycleView:
                                id: session_metric_list
                                viewclass: "MetricRow"
                                RecycleBoxLayout:
                                    default_size: None, dp(56)
                                    default_size_hint: 1, None
                                    size_hint_y: None
                                    height: self.minimum_height
                                    orientation: "vertical"
                        MDFloatingActionButton:
                            id: add_session_metric_btn
                            icon: "plus"
                            md_bg_color: app.theme_cls.primary_color
                            pos_hint: {"center_x": 0.5, "y": 0.02}
                            tooltip_text: "Add Metric"
                            opacity: 1 if root.mode != "session" else 0
                            disabled: root.mode == "session"
                            on_release: root.open_add_session_metric_popup()

            # Bottom action bar: back, add section, save
            MDBoxLayout:
                orientation: "horizontal"
                size_hint_y: None
                height: "48dp"
                spacing: "10dp"
                MDIconButton:
                    icon: "arrow-left"
                    on_release: root.go_back()
                MDIconButton:
                    icon: "plus"
                    disabled: root.mode == "session" or root.current_tab != "sections"
                    opacity: 1 if root.mode != "session" and root.current_tab == "sections" else 0
                    on_release: app.root.get_screen("edit_preset").add_section()
                MDIconButton:
                    icon: "check"
                    disabled: root.mode == "session" or not root.save_enabled
                    opacity: 1 if root.mode != "session" else 0
                    on_release: root.save_preset()

        ExerciseSelectionPanel:
            id: exercise_panel
            size_hint_x: 1
            size_hint_y: None
            height: root.height * 0.66 if root.panel_visible else 0
            y: 0
            opacity: 1 if root.panel_visible else 0
            disabled: not root.panel_visible
<SelectedExerciseItem>:
    orientation: "horizontal"
    size_hint_y: None
    height: "48dp"
    MDBoxLayout:
        size_hint_x: None
        width: "36dp"
        orientation: "horizontal"
        spacing: "5dp"
        valign: "center"

        MDIcon:
            icon: "arrow-up"
            font_size: "20sp"
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos): root.move_up()
            pos_hint: {"center_y": 0.5}
            opacity: 1 if not root.locked else 0

        MDIcon:
            icon: "arrow-down"
            font_size: "20sp"
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos): root.move_down()
            pos_hint: {"center_y": 0.5}
            opacity: 1 if not root.locked else 0
    MDLabel:
        size_hint_x: 1
        text: root.text
        halign: "center"
    MDBoxLayout:
        size_hint_x: None
        width: "36dp"  # smaller container width (half of original 72dp)
        orientation: "horizontal"
        spacing: "5dp"
        valign: "center"  # center all children vertically

        MDIcon:
            icon: "pencil"
            font_size: "20sp"  # smaller icon size
            pos_hint: {"center_y": 0.5}  # center vertically
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos): root.edit()
            opacity: 1 if not root.locked else 0

        MDIcon:
            icon: "delete"
            font_size: "20sp"
            theme_text_color: "Custom"
            text_color: 1, 0, 0, 1
            pos_hint: {"center_y": 0.5}  # center vertically
            on_touch_down: if not root.locked and self.collide_point(*args[1].pos): root.remove_self()
            opacity: 1 if not root.locked else 0

<ExerciseSelectionPanel>:
    exercise_list: exercise_list
    search_field: search_field
    orientation: "vertical"
    md_bg_color: 1, 1, 1, 1
    MDBoxLayout:
        size_hint_y: None
        height: "40dp"
        MDLabel:
            text: "Select Exercises"
            halign: "center"
        MDIconButton:
            icon: "filter-variant"
            on_release: root.open_filter_popup()
        MDIconButton:
            icon: "close"
            theme_text_color: "Custom"
            text_color: 1, 0, 0, 1
            on_release: app.root.get_screen("edit_preset").close_exercise_panel()
    MDTextField:
        id: search_field
        hint_text: "Search exercises"
        text: root.search_text
        on_text: root.update_search(self.text)
        size_hint_y: None
        height: "40dp"
    ScrollView:
        MDList:
            id: exercise_list


<DetailsTab@Tab>:
    orientation: "vertical"
    ScrollView:
        MDList:
            id: details_list

<WorkoutTab@Tab>:
    orientation: "vertical"
    ScrollView:
        MDList:
            id: workout_list

<PresetOverviewScreen>:
    details_list: details_tab.ids.details_list
    workout_list: workout_tab.ids.workout_list
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDTabs:
            id: tabs
            DetailsTab:
                id: details_tab
                title: "Details"
            WorkoutTab:
                id: workout_tab
                title: "Workout"
        MDBoxLayout:
            size_hint_y: None
            height: "40dp"
            spacing: "10dp"
            MDIconButton:
                icon: "chevron-left"
                on_release: app.root.current = "preset_detail"
            MDIconButton:
                icon: "clipboard"
                on_release: root.open_metric_popup()
            MDIconButton:
                icon: "play"
                on_release: root.start_workout()

<EditExerciseScreen>:
    metrics_list: metrics_list
    name_field: name_field
    description_field: description_field
    current_tab: "metrics"
    md_bg_color: PINK_BG
    BoxLayout:
        orientation: "vertical"
        spacing: "10dp"
        padding: "20dp"
        MDBoxLayout:
            size_hint_y: 0.1
            orientation: "horizontal"
            spacing: "10dp"
            MDIconButton:
                icon: "chevron-left"
                opacity: 1 if root.section_index >= 0 else 0
                disabled: root.section_index < 0 or not app.preset_editor or root.exercise_index <= 0
                on_release: root.go_prev_exercise()
            MDLabel:
                text: root.exercise_name if root.exercise_name else "Edit Exercise"
                halign: "center"
                theme_text_color: "Custom"
                text_color: 0.2, 0.6, 0.86, 1
            MDIconButton:
                icon: "chevron-right"
                opacity: 1 if root.section_index >= 0 else 0
                disabled: root.section_index < 0 or not app.preset_editor or root.exercise_index >= root.section_length - 1
                on_release: root.go_next_exercise()
        MDBoxLayout:
            size_hint_y: None
            height: "40dp"
            spacing: "10dp"
            MDRaisedButton:
                text: "Config"
                opacity: 1 if root.section_index >= 0 else 0
                disabled: root.section_index < 0
                size_hint_x: None
                width: dp(80) if root.section_index >= 0 else 0
                md_bg_color: app.theme_cls.primary_color if root.current_tab == "config" else (.5, .5, .5, 1)
                on_release: root.switch_tab("config") if root.section_index >= 0 else None
            MDRaisedButton:
                text: "Metrics"
                md_bg_color: app.theme_cls.primary_color if root.current_tab == "metrics" else (.5, .5, .5, 1)
                on_release: root.switch_tab("metrics")
            MDRaisedButton:
                text: "Details"
                md_bg_color: app.theme_cls.primary_color if root.current_tab == "details" else (.5, .5, .5, 1)
                on_release: root.switch_tab("details")
        ScreenManager:
            id: exercise_tabs
            size_hint_y: 1
            transition: NoTransition()
            on_kv_post: self.current = root.current_tab
            Screen:
                name: "config"
                BoxLayout:
                    orientation: "vertical"
                    spacing: "10dp"
                    size_hint_y: None
                    height: self.minimum_height
                    MDTextField:
                        id: sets_field
                        hint_text: "Sets"
                        text: str(root.exercise_sets)
                        input_filter: "int"
                        on_text: root.update_sets(self.text)
                    MDTextField:
                        id: rest_field
                        hint_text: "Rest Time (s)"
                        text: str(root.exercise_rest)
                        input_filter: "int"
                        on_text: root.update_rest(self.text)
            Screen:
                name: "metrics"
                FloatLayout:
                ScrollView:
                    MDList:
                        id: metrics_list
                MDFloatingActionButton:
                    icon: "plus"
                    md_bg_color: app.theme_cls.primary_color
                    pos_hint: {"center_x": 0.5, "y": 0.02}
                    tooltip_text: "Add Metric"
                    opacity: 1 if root.mode != "session" else 0
                    disabled: root.mode == "session"
                    on_release: root.open_add_metric_popup()
            Screen:
                name: "details"
                ScrollView:
                    MDBoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: "10dp"
                        MDTextField:
                            id: name_field
                            hint_text: "Name"
                            text: root.exercise_name
                            multiline: False
                            size_hint_x: 1
                            disabled: root.mode == "session"
                            on_text: root.update_name(self.text)
                        MDTextField:
                            id: description_field
                            hint_text: "Description"
                            text: root.exercise_description
                            multiline: True
                            size_hint_x: 1
                            disabled: root.mode == "session"
                            on_text: root.update_description(self.text)
        MDBoxLayout:
            size_hint_y: 0.1
            spacing: "10dp"
            MDRaisedButton:
                text: "Save"
                disabled: not root.save_enabled
                on_release: root.save_exercise()
            MDRaisedButton:
                text: "Back"
                on_release: root.go_back()


